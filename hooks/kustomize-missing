#!/usr/bin/env bash
set -euo pipefail

for i in $*
do
    pushd `dirname $i`
    tmpdir=$(mktemp -d)
    foundlist="$tmpdir/found"
    listedlist="$tmpdir/listed"
    find . -name \*.yaml| awk -F "/" '{print $NF}'|grep -vP '(^)?.ustomization(\.y.+)?' > $foundlist
    cat `basename $i` | grep -vP '(^)?.ustomization(\.y.+)?' > $listedlist
    export FOUND=$(cat $foundlist | wc -l)
    export LISTED=$(cat $listedlist | wc -l)
    if [[ $FOUND -ne $LISTED ]]
    then
        echo "We found $FOUND yaml files but kustomization only has $LISTED.  The following files aren't in the manifest:"
        cat `basename $i` $listedlist |grep -oFf $foundlist |sort|uniq -u
    fi
    popd
done
